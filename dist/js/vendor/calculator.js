function initFinanceTable(n){if(!$(n)[0])return!1}function getNumber(n){return n=String(n).split("").filter((function(n){return!!n.match(/^\d+$/)})).join("")}function getFloat(n){return n=String(n).replace(/[^.\d]+/g,"")}function getValueInt(n,e){if(""===n)return"";let t=+n,i=t.toFixed(0).split(""),a=i.length,o=[];e=e||"";for(let n=a-4;n>=0;n-=3)o.push(n);return t=i.map((function(n,t,i){return o.includes(t)&&(n+=" "),t===a-1&&(n=n+""+e),n})).join(""),t}function postfixYear(n){var e=" лет";return"1"===n?e=" год":"2"!==n&&"3"!==n&&"4"!==n||(e=" года"),e}function postfixMounth(n){var e=" месяцев";return"1"===n?e=" месяц":"2"!==n&&"3"!==n&&"4"!==n||(e=" месяца"),e}function priceRuble(n,e){return e?n.indexOf("млн.")>-1?n=1e6*n.replace(/\D+/g,""):n.indexOf("тыс.")>-1&&(n=1e3*n.replace(/\D+/g,"")):+n>=1e6?n=Math.round(+n/1e6)+" млн.":+n>=1e3&&(n=Math.round(+n/1e3)+" тыс."),n}function inputFocus(n){n.on("focus",(function(){const n=$(this).val().split("/"),e=+getFloat(n[1]||n[0]);$(this).val(e)}))}function inputBlur(n,e){n.on("blur",(function(){const n=$(this).val().split("/"),t=+getFloat(n[1]||n[0]);e.noUiSlider.set(t)}))}function inputChange(n,e){n.on("change",(function(){const n=$(this).val().split("/"),t=+getFloat(n[1]||n[0]);e.noUiSlider.set(t)}))}function rangeClick(n,e){n.on("click",".noUi-value-large",(function(){e.noUiSlider.set(getNumber(priceRuble($(this).text(),!0)))}))}function checkInstallment(n){1==+n?$('input[name="installment"]').prop("disabled",!1):$('input[name="installment"]').prop("disabled",!0).prop("checked",!1)}function initFinanceCalculator(){if(!$(".js-finance-calculator")[0])return!1;let n=$('.js-range-values[data-leasing-select="sum"]'),e=$('.js-range-values[data-leasing-select="time-finance"]'),t=$('.js-range-values[data-leasing-select="prepayment"]'),i=n.find("input"),a=e.find("input"),o=t.find("input"),s=n.find(".js-range-values-selection")[0],l=e.find(".js-range-values-selection")[0],c=t.find(".js-range-values-selection")[0];const u=wNumb({decimals:2,postfix:" %"});noUiSlider.create(s,{start:getNumber(i.val()),step:1e3,connect:[!0,!1],range:{min:27e4,max:3e7},pips:{mode:"values",values:[27e4,3e7],format:{to:function(n){return getValueInt(n," Р")}}},format:wNumb({decimals:0,thousand:" ",postfix:" Р"})}),noUiSlider.create(l,{start:1,step:1,connect:[!0,!1],range:{min:12,max:60},pips:{mode:"values",values:[12,60],format:{to:function(n){return n+postfixMounth(n)}}},format:wNumb({decimals:0})}),noUiSlider.create(c,{start:0,step:.5,connect:[!0,!1],range:{min:0,max:49},pips:{mode:"values",values:[0,49],format:wNumb({postfix:" %"})},format:{to:function(n){return u.to(n)},from:function(n){return u.from(n)}}}),s.noUiSlider.on("update",(function(n,e){i.val(n[e]),o.trigger("change")})),l.noUiSlider.on("update",(function(n,e){a.val(n[e]+postfixMounth(n[e])),checkInstallment(n[e])})),c.noUiSlider.on("update",(function(n,e){const t=n[e].split("/"),i=+getFloat(t[1]||t[0]),a=getValueInt(+getNumber($('.js-finance-calculator input[name="finance-calc-sum"]').val())*+getFloat(i)/100," Р")+" / "+u.to(i);o.val(a)})),inputFocus(i),inputFocus(a),inputFocus(o),inputBlur(i,s),inputBlur(a,l),inputBlur(o,c),inputChange(i,s),inputChange(a,l),inputChange(o,c),rangeClick(n,s),rangeClick(e,l),rangeClick(t,c)}function countLinearDepreciation(n,e){return(10*n/100/12/1.2).toFixed(1)*e}function countPMT(n,e,t,i,a){if(i=void 0!==i?i:0,a=void 0!==a?a:0,0!=n){var o=Math.pow(1+n,e);return-n*(i+o*t)/((-1+o)*(1+n*a))}return 0!=e?-(i+t)/e:0}function countPaymentLeasing(n,e,t,i){let a=i/100/12;return(n-e)*(a+a/(Math.pow(1+a,t)-1))}function countPaymentCredit(n,e,t,i){return-countPMT(i/12/100,t,n-e)}function getTaxRefund(n,e){return 20===e?20*n/120:0}function getTaxCutsLeasing(n,e,t,i){return 20===i?e/1.2*.2:15===i?.15*(e/1.2+n):0}function getTaxCutsCredit(n,e,t,i){let a=countLinearDepreciation(n,t),o=e-n;return 20===i?.2*(o+a):15===i?.15*(o+a):0}function getTaxCutsMoney(n,e,t,i){let a=countLinearDepreciation(n,t);return 20===i?.2*a:15===i?.15*a:0}function getMonthList(n){let e=[],t=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],i=new Date,a=i.getMonth(),o=i.getFullYear();for(let i=0;i<n;i++){0===a&&i>0&&o++;let n=t[a]+" "+o;e.push(n),a++,a=12===a?0:a}return e}function viewPercent(n,e){return e=e||0,new String(n.toFixed(e)).replace(".",",")+" %"}function createLineGrapf(n,e,t,i){t=getValueInt(t=""===$.trim(t)?t:t.toFixed(0));return i&&(t+=' <div class="financeCalculator__infoPopup infoPopup infoPopup_product js-info-popup initialized"><button class="infoPopup__link infoPopup__link_product js-info-popup-link"><svg width="18" height="18"><use xlink:href="/lizing/sprite.svg#info"></use></svg></button><div class="infoPopup__inside infoPopup__inside_prod js-info-popup-inside initialized"><button class="infoPopup__close js-info-popup-close"><svg width="16" height="16"><use xlink:href="/lizing/sprite.svg#cross"></use></svg></button><div class="infoPopup__results infoPopup__results_course"><div class="infoPopup__lineResult">Общая сумма платежей, в т.ч. аванс и переплата.</div></div></div></div>'),'<div class="tline"><div class="td td_empty"></div><div class="td td_small">'+(n=n?'<div class="tcell">'+n+"</div>":"")+'</div><div class="td"><div class="tcell">'+e+'</div></div><div class="td"><div class="tcell">'+t+'</div></div><div class="td td_empty"></div></div>'}function standartCount(n,e,t,i,a){const o={leasing:16,credit:"individual"===a?24:13.5};let s={leasing:n/100*t,credit:n/100*t,money:n},l={leasing:countPaymentLeasing(n,s.leasing,e,o.leasing),credit:countPaymentCredit(n,s.credit,e,o.credit)},c={leasing:s.leasing+l.leasing*e,credit:s.credit+l.credit*e,money:s.money},u={leasing:c.leasing-n,credit:c.credit-n},r={leasing:getTaxRefund(c.leasing,i),credit:getTaxRefund(n,i),money:getTaxRefund(n,i)},p={leasing:getTaxCutsLeasing(c.credit-n,c.leasing,e,i),credit:getTaxCutsCredit(n,c.credit,e,i),money:getTaxCutsMoney(n,c.money,e,i)},d={leasing:r.leasing+p.leasing,credit:r.credit+p.credit,money:r.money+p.money},f={leasing:c.leasing-d.leasing,credit:c.credit-d.credit,money:c.money-d.money},g={leasing:c.leasing-f.leasing,credit:c.credit-f.credit,money:c.money-f.money},m={leasing:viewPercent(100*(1-1/(c.leasing/f.leasing))),credit:viewPercent(100*(1-1/(c.credit/f.credit))),money:viewPercent(100*(1-1/(c.money/f.money)))},v={leasing:viewPercent((c.leasing-n)/n/(e/12)*100,1),credit:viewPercent(o.credit,1),money:viewPercent(0,1)},h=[],$=n/100*t,C="-";C="individual"===a?$+l.credit*e:$+l.leasing*e;for(let n=1;n<=e;n++)"individual"===a?h.push(l.credit):h.push(l.leasing);return{payment:l,rate:v,taxRefund:r,taxCuts:p,resultTax:d,resultExpenses:c,overpayment:u,financeResult:f,saving:g,savingPercent:m,time:e,prepaid:$,payments:h,total:C}}function seasonalBusinessCount(n,e,t){let i=[],a=n/100*t,o=countPaymentLeasing(n,a,e,16),s=.5*o,l=1.5*o,c=a+(s+l)*e/2;for(let n=1;n<=e;n++)n%6>0&&n%6<4?i.push(s):i.push(l);return{time:e,prepaid:a,payments:i,total:c}}function installmentCount(n,e,t){let i=[],a=n/100*t,o=countPaymentLeasing(n,a,6,28),s=a+6*o+10800;for(let n=1;n<=12;n++)n<=6?i.push(o):i.push(1800);return{time:12,prepaid:a,payments:i,total:s}}function leasingHolidaysCount(n,e,t,i){let a=[],o=n/100*t,s=countPaymentLeasing(n,o,e,16)*e/(e-i),l=o+s*(e-i);for(let n=1;n<=e;n++)n<=i?a.push(0):a.push(s);return{time:e,prepaid:o,payments:a,total:l}}function viewFinanceTable(n,e,t){let i=n.find(".js-finance-table-result"),a=i.find('[data-finance-elem="table"]');function o(n,e,t){e=t||""===$.trim(e)?e:e.toFixed(0),t?a.find('[data-table-cell="'+n+'"]').html(e):a.find('[data-table-cell="'+n+'"]').html(getValueInt(e))}o("leasing-payment",e.payment.leasing),o("leasing-rate",e.rate.leasing,!0),o("leasing-tax-refund",e.taxRefund.leasing),o("leasing-tax-cuts",e.taxCuts.leasing),o("leasing-result-tax",e.resultTax.leasing),o("leasing-result-expenses",e.resultExpenses.leasing),o("leasing-result-overpayment",e.overpayment.leasing),o("leasing-result",e.financeResult.leasing),o("leasing-saving",e.saving.leasing),o("leasing-saving-percent",e.savingPercent.leasing,!0),!t&&i.addClass("open"),getFinanceConditions()}function getFinanceConditions(n){let e=$(".js-finance-condition"),t=$(".js-finance-form"),i=/(\s+)/g,a="",o=$(".leasingFormData__value",t);o.length&&o.each((function(){let n=$(this);a+=n.find(".leasingFormData__name").text().trim().replace(i," ")+": "+n.find(".leasingFormData__input").val().trim().replace(i," ")+"\r\n"}));let s=e.find(".tline");if(s.length){let n=$(".financeCalculator__selection_checkboxes",e);n.length&&(a+="Налоговый режим: ",a+=$("input:checked",n).parent().text().trim().replace(i," ")+"\r\n"),a+="\r\n",s.each((function(){a+=$(this).text().trim().replace(i," ")+"\r\n"}))}$(".js-popup-show",e).data("autoload-detail",a)}function calculationFinance(n,e){const t=n.parents(".js-discont-section").attr("data-discont-section-name").trim()||"entity";let i=+getNumber(n.find('input[name="finance-calc-sum"]').val()),a=+getNumber(n.find('input[name="finance-calc-time"]').val()),o=n.find('input[name="finance-calc-prepaid"]').val().split("/"),s=+getNumber(n.find('input[name="finance-calc-tax-regime"]:checked').val());o=+getFloat(o[1]||o[0]),viewFinanceTable(n,standartCount(i,a,o,s,t),e)}function initEventsFinanceCalculation(){if(!$(".js-finance-calculator")[0])return!1;let n=$(".js-finance-calculator").find(".js-range-values-selection"),e=0;$(".js-count-finance-calculator").on("click",(function(n){n.preventDefault(),calculationFinance($(this).parents(".js-finance-calculator"))})),$('.js-finance-calculator input[type="radio"]').on("change",(function(){calculationFinance($(this).parents(".js-finance-calculator"))}));for(let t=0;t<n.length;t++){const i=n[t];i.noUiSlider.on("update",(function(){e++,e>n.length&&calculationFinance($(i).parents(".js-finance-calculator"))}))}calculationFinance($(".js-finance-calculator"),!0)}function positionInfoPopup(n,e){let t=$(document).outerWidth(),i=$(n).outerWidth(),a=$(n).outerHeight(),o=$(n).offset().top+a+5,s=$(n).offset().left;e.css({top:0,left:0}).appendTo("body");let l=e.outerWidth(),c=s+l;c>t&&s+i-l<0?(e.removeClass("infoPopup__inside_left").addClass("infoPopup__inside_center"),s="50%"):c>t?(e.removeClass("infoPopup__inside_center").addClass("infoPopup__inside_left"),s+=i):e.removeClass("infoPopup__inside_center").removeClass("infoPopup__inside_left"),e.css({top:o,left:s})}function toggleAdvInfo(n,e){let t=n.parents(".js-info-popup"),i=t.find(".js-info-popup-inside").clone();t.hasClass("open")||e?($(".js-info-popup.open").removeClass("open"),$(".js-info-popup-inside.open").removeClass("open").slideUp(200,(function(){$(this).remove()}))):($(".js-info-popup.open").removeClass("open"),$(".js-info-popup-inside.open").removeClass("open").slideUp(200,(function(){$(this).remove()})),positionInfoPopup(t,i),t.addClass("open"),i.addClass("open").slideDown(200))}function toggleAdvInfoMobile(n){n.hasClass("open")?n.removeClass("open").siblings(".js-info-popup").slideUp(200):($(".js-info-control.open").removeClass("open").siblings(".js-info-popup").slideUp(200),n.addClass("open").siblings(".js-info-popup").slideDown(200))}$(document).ready((function(){initFinanceTable(".js-finance-table"),initFinanceCalculator(),initEventsFinanceCalculation()})),$(document).ready((function(){$(".js-info-popup").addClass("initialized"),$(".js-info-popup-inside").addClass("initialized"),$(document).on("click",".js-info-popup-link",(function(n){n.preventDefault(),toggleAdvInfo($(this))})),$(document).on("click",".js-info-popup-close",(function(n){n.preventDefault(),toggleAdvInfo($(this),!0)})),$(document).on("click",".js-info-control",(function(n){n.preventDefault(),toggleAdvInfoMobile($(this))})),$(document).on("click",(function(n){if($(".js-info-popup-inside.open")[0]&&!$(n.target).hasClass("js-info-popup-inside")&&!$(n.target).parents(".js-info-popup-inside")[0]&&!$(n.target).hasClass("js-info-popup")&&!$(n.target).parents(".js-info-popup")[0]){let n=$(".js-info-popup.open");for(let e=0;e<n.length;e++){toggleAdvInfo($(n[e]).find(".js-info-popup-link"),!0)}}}))}));